<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nexa Agents - Dashboard</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    /* Add dashboard styles */
    .metrics-section { 
        background: white; 
        padding: 10px 12px;
        margin: 6px 0; 
        border-radius: 6px; 
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .metrics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        user-select: none;
        padding: 4px 0;
    }
    .metrics-content { 
        overflow: hidden;
        transition: max-height 0.2s ease-out;
        max-height: 0;
    }
    .metrics-content.expanded { 
        max-height: 800px; 
        padding: 8px;
    }
    .metric-value { 
        font-size: 20px; 
        font-weight: bold; 
        color: #2196F3;
        margin: 6px 0;
    }
    .metric-label { color: #666; font-size: 13px; }
    .arrow {
        transition: transform 0.2s;
        font-size: 18px;
    }
    .expanded .arrow { transform: rotate(180deg); }
    .error { color: #f44336; }
    .success { color: #4CAF50; }
    .metric-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    .metric-item:last-child {
        border-bottom: none;
    }
  </style>
  <!-- Add this inside <head> section, before your other scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="dashboard">
    <header class="header">
      <h1>Nexa Configuration Dashboard</h1>
      <div class="actions">
        <button id="save-all-btn" class="btn primary">Save All Changes</button>
        <button id="restore-btn" class="btn secondary">Restore Defaults</button>
      </div>
    </header>

    <div class="tabs">
      <button class="tab-btn active" data-tab="server">Server</button>
      <button class="tab-btn" data-tab="providers">LLM Providers</button>
      <button class="tab-btn" data-tab="tools">Tools</button>
      <button class="tab-btn" data-tab="agents">Agents</button>
      <button class="tab-btn" data-tab="features">Features</button>
      <button class="tab-btn" data-tab="backup">Backup</button>
    </div>

    <div class="tab-content">
      <!-- Server Settings Tab -->
      <div class="tab-pane active" id="server-tab">
        <h2>Server Configuration</h2>
        <form id="server-form" class="settings-form">
          <div class="form-group">
            <label for="server-port">Port</label>
            <input type="number" id="server-port" name="PORT" min="1" max="65535" value="3001">
          </div>
          <div class="form-group">
            <label for="server-host">Host</label>
            <input type="text" id="server-host" name="HOST" value="0.0.0.0">
          </div>
          <div class="form-group">
            <label for="server-env">Environment</label>
            <select id="server-env" name="NODE_ENV">
              <option value="development">Development</option>
              <option value="production">Production</option>
              <option value="testing">Testing</option>
            </select>
          </div>
          <div class="form-group">
            <label for="api-timeout">API Timeout (ms)</label>
            <input type="number" id="api-timeout" name="API_TIMEOUT" min="1000" step="1000" value="30000">
          </div>
          <div class="form-group">
            <label>Clustering</label>
            <div class="checkbox-group">
              <input type="checkbox" id="enable-clustering" name="ENABLE_CLUSTERING">
              <label for="enable-clustering">Enable Clustering</label>
            </div>
          </div>
          <div class="form-group">
            <label for="worker-count">Worker Count (0 = auto)</label>
            <input type="number" id="worker-count" name="WORKER_COUNT" min="0" value="0">
          </div>
        </form>
      </div>

      <!-- LLM Providers Tab -->
      <div class="tab-pane" id="providers-tab">
        <h2>LLM Providers</h2>
        <div class="providers-list" id="providers-list">
          <!-- Providers will be added here dynamically -->
        </div>
        <button id="add-provider-btn" class="btn">Add Provider</button>
      </div>

      <!-- Tools Tab -->
      <div class="tab-pane" id="tools-tab">
        <h2>Available Tools</h2>
        <div class="tools-list" id="tools-list">
          <!-- Tools will be added here dynamically -->
        </div>
        <button id="add-tool-btn" class="btn">Add Tool</button>
      </div>

      <!-- Agents Tab -->
      <div class="tab-pane" id="agents-tab">
        <h2>Configured Agents</h2>
        <div class="agents-list" id="agents-list">
          <!-- Agents will be added here dynamically -->
        </div>
        <button id="add-agent-btn" class="btn">Add Agent</button>
      </div>

      <!-- Features Tab -->
      <div class="tab-pane" id="features-tab">
        <h2>Feature Flags</h2>
        <form id="features-form" class="settings-form">
          <!-- Features will be added here dynamically -->
        </form>
      </div>

      <!-- Backup Tab -->
      <div class="tab-pane" id="backup-tab">
        <h2>Backup and Restore</h2>
        <div class="backup-actions">
          <button id="create-backup-btn" class="btn">Create Backup</button>
        </div>
        <h3>Available Backups</h3>
        <div class="backups-list" id="backups-list">
          <!-- Backups will be added here dynamically -->
        </div>
      </div>
    </div>

    <div class="dashboard-footer">
      <span id="status-message"></span>
      <span id="save-indicator"></span>
    </div>
  </div>

  <!-- Templates -->
  <template id="provider-template">
    <div class="provider-item card">
      <div class="card-header">
        <h3 class="provider-name">Provider Name</h3>
        <div class="card-actions">
          <button class="btn-edit btn-small">Edit</button>
          <button class="btn-toggle btn-small">Disable</button>
          <button class="btn-delete btn-small">Delete</button>
        </div>
      </div>
      <div class="card-body">
        <div class="provider-details"></div>
      </div>
    </div>
  </template>

  <template id="provider-form-template">
    <form class="provider-form">
      <div class="form-group">
        <label for="provider-name">Name</label>
        <input type="text" name="name" required>
      </div>
      <div class="form-group">
        <label for="provider-type">Type</label>
        <select name="type">
          <option value="openai">OpenAI</option>
          <option value="lmstudio">LM Studio</option>
          <option value="ollama">Ollama</option>
          <option value="custom">Custom</option>
        </select>
      </div>
      <div class="form-group">
        <label for="provider-url">Base URL</label>
        <input type="url" name="baseUrl">
      </div>
      <div class="form-group">
        <label for="provider-apikey">API Key</label>
        <input type="password" name="apiKey">
      </div>
      <div class="form-group">
        <label for="provider-models">Models (comma-separated)</label>
        <input type="text" name="models">
      </div>
      <div class="form-group">
        <label for="provider-temp">Temperature</label>
        <input type="range" name="temperature" min="0" max="1" step="0.1" value="0.7">
        <span class="range-value">0.7</span>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn primary">Save</button>
        <button type="button" class="btn cancel">Cancel</button>
      </div>
    </form>
  </template>

  <div class="container">
    <div id="metrics-dashboard">
        <h2>System Metrics</h2>
        
        <div class="metrics-section">
            <div class="metrics-header" onclick="toggleSection('summary-content')">
                <h3>Summary</h3>
                <span class="arrow">▼</span>
            </div>
            <div id="summary-content" class="metrics-content">
                <div id="summary-metrics" class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-label">Active Agents</div>
                        <div class="metric-value" id="active-agents">0</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Running Tools</div>
                        <div class="metric-value" id="active-tools">0</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">API Health</div>
                        <div class="metric-value" id="api-health">OK</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Total Requests</div>
                        <div class="metric-value" id="total-requests">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="metrics-section">
            <div class="metrics-header" onclick="toggleSection('llm-content')">
                <h3>LLM Performance</h3>
                <span class="arrow">▼</span>
            </div>
            <div id="llm-content" class="metrics-content">
                <div id="llm-metrics" class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-label">LLM Response Time</div>
                        <div class="metric-value" id="llm-response-time">0ms</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Tokens/Min</div>
                        <div class="metric-value" id="tokens-per-min">0</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Active Models</div>
                        <div class="metric-value" id="active-models">0</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Error Rate</div>
                        <div class="metric-value" id="llm-error-rate">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="metrics-section">
            <div class="metrics-header" onclick="toggleSection('network-content')">
                <h3>Network Status</h3>
                <span class="arrow">▼</span>
            </div>
            <div id="network-content" class="metrics-content">
                <div id="network-metrics" class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-label">API Latency</div>
                        <div class="metric-value" id="api-latency">0ms</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Requests/Min</div>
                        <div class="metric-value" id="requests-per-min">0</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Active Connections</div>
                        <div class="metric-value" id="active-connections">0</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Data Throughput</div>
                        <div class="metric-value" id="data-throughput">0KB/s</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="metrics-section">
            <div class="metrics-header" onclick="toggleSection('system-content')">
                <h3>System Health</h3>
                <span class="arrow">▼</span>
            </div>
            <div id="system-content" class="metrics-content">
                <div class="metrics-grid">
                    <!-- CPU Usage -->
                    <div class="metric-chart">
                        <h4>CPU Usage</h4>
                        <div class="chart-container">
                            <canvas id="cpuChart"></canvas>
                        </div>
                        <div class="cpu-cores">
                            <div class="core-stats" id="cpu-cores-stats"></div>
                        </div>
                    </div>

                    <!-- Memory Usage -->
                    <div class="metric-chart">
                        <h4>Memory Usage</h4>
                        <div class="chart-container">
                            <canvas id="memoryChart"></canvas>
                        </div>
                        <div class="memory-breakdown">
                            <div class="memory-stats" id="memory-stats"></div>
                        </div>
                    </div>

                    <!-- Network Throughput -->
                    <div class="metric-chart">
                        <h4>Network Throughput</h4>
                        <div class="chart-container">
                            <canvas id="networkChart"></canvas>
                        </div>
                        <div class="network-stats">
                            <div class="interface-stats" id="network-stats"></div>
                        </div>
                    </div>

                    <!-- System Load -->
                    <div class="metric-chart">
                        <h4>System Load</h4>
                        <div class="chart-container">
                            <canvas id="loadChart"></canvas>
                        </div>
                        <div class="load-stats">
                            <div class="load-values" id="load-stats"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <style>
            .metric-chart {
                margin: 12px 0;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 6px;
            }
            .chart-container {
                position: relative;
                height: 160px;
                margin: 8px 0;
            }
            .cpu-cores, .memory-breakdown, .network-stats, .load-stats {
                margin-top: 10px;
                padding: 8px;
                background: white;
                border-radius: 4px;
            }
            .core-stats, .memory-stats, .interface-stats, .load-values {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
            .stat-item {
                padding: 6px;
                background: #f0f0f0;
                border-radius: 3px;
                text-align: center;
            }
            .stat-label {
                font-size: 11px;
                color: #666;
            }
            .stat-value {
                font-size: 13px;
                font-weight: bold;
                color: #333;
            }
        </style>

        <div class="metrics-section">
            <div class="metrics-header" onclick="toggleSection('logs-content')">
                <h3>System Logs</h3>
                <span class="arrow">▼</span>
            </div>
            <div id="logs-content" class="metrics-content">
                <div id="logViewerContainer">
                    <div class="log-controls">
                        <select id="log-level-filter">
                            <option value="all">All Levels</option>
                            <option value="info">Info</option>
                            <option value="warn">Warnings</option>
                            <option value="error">Errors</option>
                        </select>
                        <input type="text" id="log-search" placeholder="Search logs...">
                    </div>
                    <div class="log-list" id="log-list"></div>
                </div>
            </div>
        </div>
    </div>
  </div>

  <!-- Update the script initialization -->
  <script>
    // Initialize global socket before other scripts
    window.socket = io({
      transports: ['websocket', 'polling'],
      reconnection: true,
      reconnectionAttempts: 5,
      reconnectionDelay: 1000
    });

    function toggleSection(id) {
      const content = document.getElementById(id);
      content.classList.toggle('expanded');
      // If we're expanding this section, ensure the metrics are loaded
      if (content.classList.contains('expanded')) {
        // This will trigger a metrics refresh if the metrics.js is loaded
        if (typeof refreshMetrics === 'function') {
          refreshMetrics();
        }
      }
    }

    // Add socket connection status indicator
    socket.on('connect', () => {
      console.log('Socket connected');
      document.getElementById('status-message').textContent = 'Connected to server';
      document.getElementById('status-message').className = 'status-success';
    });

    socket.on('connect_error', (error) => {
      console.error('Socket connection error:', error);
      document.getElementById('status-message').textContent = 'Connection error';
      document.getElementById('status-message').className = 'status-error';
    });

    // Listen for metrics updates from the server
    socket.on('metrics_update', (data) => {
      updateAllMetrics(data);
    });

    // Request metrics on page load
    document.addEventListener('DOMContentLoaded', () => {
      socket.emit('get_metrics');
      
      // Expand the summary section by default
      toggleSection('summary-content');
    });

    // Format bytes to human-readable format
    function formatBytes(bytes, decimals = 2) {
      if (bytes === 0) return '0 Bytes';
      
      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
      
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // Format time to human-readable format
    function formatTime(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      return `${hours}h ${minutes}m`;
    }

    // Update all metrics sections with data from the server
    function updateAllMetrics(data) {
      // Update summary metrics
      if (data.summary) {
        document.getElementById('active-agents').textContent = data.summary.activeAgents || 0;
        document.getElementById('active-tools').textContent = data.summary.activeTools || 0;
        document.getElementById('api-health').textContent = data.summary.apiHealth || 'OK';
        document.getElementById('total-requests').textContent = data.network?.summary?.requestsPerSecond || 0;
      }

      // Update LLM metrics
      if (data.llm) {
        document.getElementById('llm-response-time').textContent = 
          `${Math.round(data.llm.averageLatency || 0)}ms`;
        document.getElementById('tokens-per-min').textContent = 
          Math.round((data.llm.tokensPerSecond || 0) * 60);
        
        // Count active models
        const activeModels = data.llm.models ? Object.keys(data.llm.models).length : 0;
        document.getElementById('active-models').textContent = activeModels;
        
        // Calculate error rate
        const errorRate = data.llm.requestCount > 0 
          ? ((data.llm.errors || 0) / data.llm.requestCount * 100).toFixed(1) 
          : '0.0';
        document.getElementById('llm-error-rate').textContent = `${errorRate}%`;
      }

      // Update network metrics
      if (data.network) {
        document.getElementById('api-latency').textContent = 
          `${Math.round(data.network.summary.averageLatency || 0)}ms`;
        document.getElementById('requests-per-min').textContent = 
          Math.round((data.network.summary.requestsPerSecond || 0) * 60);
        document.getElementById('active-connections').textContent = 
          data.network.summary.connectionsActive || 0;
        
        // Format throughput
        const throughput = data.network.detailed?.traffic?.rateOut || 0;
        document.getElementById('data-throughput').textContent = formatBytes(throughput) + '/s';
      }

      // Update system metrics
      if (data.system) {
        document.getElementById('cpu-usage').textContent = 
          `${Math.round(data.system.cpu || 0)}%`;
        
        const memoryUsed = data.system.memory?.used || 0;
        document.getElementById('memory-usage').textContent = formatBytes(memoryUsed);
        
        // Calculate disk usage (mock data for now)
        const diskUsage = Math.round(Math.random() * 30 + 40); // 40-70% range
        document.getElementById('disk-usage').textContent = `${diskUsage}%`;
        
        // Format uptime
        document.getElementById('system-uptime').textContent = 
          formatTime(data.system.uptime || 0);
      }
    }
  </script>

  <!-- Load application scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="/js/dashboard.js"></script>
  <script src="/js/logViewer.js"></script>
  <!-- Add metrics JavaScript -->
  <script src="/js/metrics.js"></script>
</body>
</html>
